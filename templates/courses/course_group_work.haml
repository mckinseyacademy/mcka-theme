- extends "courses/course_navigation.haml"
- load staticfiles

- block page_title
  %title
    = program.display_name
    = _(" | Group Work | Courses | McKinsey Academy")

- block help_context
  #mckinsey_help.reveal-modal.medium{'data-reveal': None}
    .close-reveal-modal
      %i.fa.fa-times-circle
    .sub-1 Group Work
    - if group_project.is_v2
      %p Below are helpful tips to contribute to group work. You may also find answers to your questions in the <a href="/faq">FAQ</a>. Can’t find the answer there? Please contact us directly at <a href="mailto:support@mckinseyacademy.com">support@mckinseyacademy.com</a> and we’ll sort it out for you.
      .help-line Access group work using the <i class="mk-icon-groupworknav blue"></i> icon in the main navigation bar
      .help-line Upload deliverables by clicking the <i class="fa fa-upload blue"></i> icon at the bottom of the Project Navigator.
      .help-line Access project resources by clicking the <i class="fa fa-files-o blue"></i> icon at the bottom of the Project Navigator.
      .help-line Group work has a private discussion you can use to collaborate with your group members.You can chat with your team by clicking the <i class="fa fa-comments-o blue"></i> icon at the bottom of the Project Navigator. Your private discussions, even when viewed on the main discussion page, are only visible to your group members, never to the larger cohort.
      .help-line Send a message to a McKinsey TA by clicking the <span class="nav-1" style="font-size:16px;">TA</span> icon at the bottom of the Project Navigator.
    - else
      %p Below are helpful tips to contribute to group work. You may also find answers to your questions in the <a href="/faq">FAQ</a>. Can’t find the answer there? Please contact us directly at <a href="mailto:support@mckinseyacademy.com">support@mckinseyacademy.com</a> and we’ll sort it out for you.
      .help-line Access group work using the <i class="mk-icon-groupworknav"></i> icon in the main navigation bar
      .help-line Group work is made up of one or more activities, and each activity is made up of up to 4 stages:
      .help-line OVERVIEW - provides a high-level overview of the task(s)
      .help-line UPLOAD - allows your team to upload deliverables for TA or peer grading
      .help-line REVIEWS - allows you to anonymously grade peer projects and/or provide team feedback
      .help-line GRADE - displays your team feedback and peer (or TA) grade
      .help-line
        .page-left
          %i.fa.fa-chevron-left
        Move from stage to stage within an activity using the left and right arrows; deadlines for each stage are posted, and if a particular stage has not yet opened, it is noted
      .help-line Group work has a private inline discussion you can use to collaborate with only your group members. View these conversations in group work pages, or by accessing the larger discussion page using the <i class="fa fa-comments-o"></i> icon in the main navigation bar. Your private discussions, even when viewed on the main discussion page, are only visible to your group members, never to the larger cohort.
      .help-line Email your group members (individually or combined) from the right column of each stage
      .help-line Email your McKinsey TA from the right column of each stage.
      .help-line This video walks you through the group work experience:
      #mk-help-video{'data-video-id': "F0cmwxcjoRJg4g6GAcZGCl4dAGJKQ1Cj"}


- block current_content
  #course-group-work
    %a.global-help{'data-reveal-id': 'mckinsey_help'}
      %i.fa.fa-question-circle
    - if not group_project or not project_group
      .row
        .error= _("Group work has not yet begun for this course. You will receive a message with information once it begins")
    - else
      - if not group_project.is_v2
        .row
          - include "courses/group_work/activity_menu.haml"
      .row
        - if group_project.is_v2
          .large-12.medium-12.columns.splitpiece.left
            .lesson-title
              %span= _("Group Project:")
              %span= group_project.name
            .lesson-content
        - else
          .large-8.medium-8.columns.splitpiece.left
            .lesson-title
              %span= _("Group Project:")
              %span= group_project.name
            .lesson-content
          #group-project-users.large-4.medium-4.columns.splitpiece.right
            .group-members
              %h4= _("Group Members")
              - for member in project_group.members
                - include "courses/group_work/group_member.haml" with group_member=member data_reveal_id="email-member"
              - if project_group.id
                %a.email-team{href: "#", data-reveal-id: 'email-team'}
                  = _("Email your group")
            %hr
            - if ta_user.id and not course.ended
              .ask-ta
                %h4= _("Ask a TA")
                -# Temporarily use mailto: for ta link as well (add data_reveal_id back in for when dialog should be introduced
                - include "courses/group_work/group_member.haml" with group_member=ta_user data_reveal_id="contact-ta"
                -# include "courses/group_work/group_member.haml" with group_member=project_group.teaching_assistant
            - include "courses/contact_ta.haml" with contact_from="group-work"
- block js_snippets
  %script{src: "{% static 'js/course_contact_modal.js' %}"}
  :javascript
    $(function(){
      var adjust_discussion_height = function(){
        $('.discussion-module').css('visibility', 'hidden');
        _.defer(function(){
          $('.discussion-module').css('margin-top', 'auto');

          var height_left = $('.group-project-xblock-wrapper').height();
          var height_right = $('#group-project-users').height();

          if (height_right > height_left){
            $('.discussion-module').css('margin-top', (height_right - height_left).toString()+'px');
          }
          $('.discussion-module').css('visibility', 'visible');
        });
      };

      var group_activity_step_map = {};
      $(document).on('steps_available', function(target, step_map){
        group_activity_step_map = step_map;
        var activity_dots = $('.activity_dots');
        var ordered_list = group_activity_step_map.ordered_list;
        for(var i=0; i<ordered_list.length; ++i){
          var step = group_activity_step_map[ordered_list[i]];
          var dot = $('<a>')
            .addClass('lesson-module-status')
            .attr('href', '#')
            .attr('title', step.name)
            .attr('data-activate', ordered_list[i]);
          activity_dots.append(dot);
        }
      });

      $(document).on('select_stage', function(target, activate_id){
        if (!group_activity_step_map.ordered_list) {
          return;
        }
        var ordered_list = group_activity_step_map.ordered_list;
        var add_class = "complete";
        $('.activity_dots .lesson-module-status').removeClass('complete current');
        for(var i=0; i<ordered_list.length; ++i){
          if(ordered_list[i] == activate_id){
            $('.activity_dots .lesson-module-status[data-activate="'+activate_id+'"]')
              .addClass('current');
            add_class = null;
          }
          else if(add_class){
            $('.activity_dots .lesson-module-status[data-activate="'+ordered_list[i]+'"]')
              .addClass(add_class);
          }
        }
      });

      $('#course-group-work').on('click', '.lesson-module-status', function(){
        $(document).trigger('select_stage', $(this).data('activate'));
      });

      // height may have changed whenever we load new data into the xblock... need to re-check height at this point
      $(document).on('select_stage', adjust_discussion_height);
      $(document).on('data_loaded', adjust_discussion_height);

      var lesson_content = $('#{{ lesson_content_parent_id }} .lesson-content');
      var lesson_data = {
        courseId: '{{ legacy_course_id }}',
        usageId: '{{ vertical_usage_id }}',
        sessionId: '{{ remote_session_key }}',
        baseDomain: '{{ lms_base_domain }}',
        lmsSubDomain: '{{ lms_sub_domain }}',
        jumpLinkRewriter: Apros.jumpLinkRewriter,
        data: {
            activate_block_id: Apros.getParameterByName('activate_block_id'),
        },
        {% if use_current_host %}
        useCurrentHost: true,
        {% endif %}
      };

      lesson_content.xblock(lesson_data);

      {% if select_stage %}
      $(document).on('activity_initialized', function() {
        $(document).trigger('select_stage', '{{ select_stage }}');
      });
      {% endif %}
    });
